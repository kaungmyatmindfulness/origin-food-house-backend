datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id              String    @id @default(uuid(7))
  email           String    @unique
  name            String?
  auth0Id         String?   @unique
  isEmailVerified Boolean   @default(false)
  verified        Boolean   @default(false)

  // Slice B: Suspension tracking
  isSuspended     Boolean   @default(false)
  suspendedAt     DateTime?
  suspendedReason String?

  // JWT invalidation version (incremented on suspension or security events)
  jwtVersion      Int       @default(0)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @default(now()) @updatedAt

  userStores UserStore[]
}

model Store {
  id        String   @id @default(uuid(7))
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  userStores          UserStore[]
  categories          Category[]
  menuItems           MenuItem[]
  tables              Table[]
  information         StoreInformation?
  setting             StoreSetting?
  orders              Order[]
  activeTableSessions ActiveTableSession[]
  carts               Cart[]
  tier                StoreTier?
  auditLogs           AuditLog[]
  staffInvitations    StaffInvitation[]

  @@index([slug])
}

model UserStore {
  id      String @id @default(uuid(7))
  userId  String
  storeId String
  role    Role

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([userId, storeId])
  @@index([userId])
}

model StoreInformation {
  id            String   @id @default(uuid(7))
  storeId       String   @unique
  store         Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  name          String
  logoUrl       String?
  coverPhotoUrl String?
  address       String?
  phone         String?
  email         String?
  website       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt
}

model StoreSetting {
  id                String   @id @default(uuid(7))
  storeId           String   @unique
  store             Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  currency          Currency @default(USD)
  vatRate           Decimal? @default(0.07) @db.Decimal(4, 3)
  serviceChargeRate Decimal? @default(0.0) @db.Decimal(4, 3)

  // Slice B: Business Hours
  businessHours          Json?    // { "monday": { "open": "09:00", "close": "22:00" }, ... }
  specialHours           Json?    // [{ "date": "2025-12-25", "open": null, "close": null, "reason": "Christmas" }]
  acceptOrdersWhenClosed Boolean  @default(false)

  // Slice B: Loyalty Program Rules
  loyaltyEnabled         Boolean  @default(false)
  loyaltyPointRate       Decimal? @db.Decimal(10, 4) // e.g., 0.1 (1 point per 10 THB)
  loyaltyRedemptionRate  Decimal? @db.Decimal(10, 4) // e.g., 0.1 (100 points = 10 THB)
  loyaltyPointExpiryDays Int?     @default(365)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now()) @updatedAt
}

model Category {
  id        String    @id @default(uuid(7))
  name      String
  storeId   String
  store     Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  sortOrder Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @default(now()) @updatedAt
  deletedAt DateTime?

  menuItems MenuItem[]

  @@unique([storeId, name, deletedAt])
  @@index([storeId, sortOrder])
  @@index([deletedAt])
}

model MenuItem {
  id                     String      @id @default(uuid(7))
  name                   String
  description            String?
  basePrice              Decimal     @db.Decimal(10, 2)
  imageUrl               String?
  categoryId             String
  storeId                String
  sortOrder              Int         @default(0)
  isOutOfStock           Boolean     @default(false)
  isHidden               Boolean     @default(false)
  routingArea            RoutingArea @default(OTHER)
  preparationTimeMinutes Int?
  createdAt              DateTime    @default(now())
  updatedAt              DateTime    @default(now()) @updatedAt
  deletedAt              DateTime?

  category            Category             @relation(fields: [categoryId], references: [id])
  store               Store                @relation(fields: [storeId], references: [id], onDelete: Cascade)
  customizationGroups CustomizationGroup[]
  orderItems          OrderItem[]
  cartItems           CartItem[]

  @@index([storeId, categoryId, sortOrder])
  @@index([storeId, routingArea])
  @@index([deletedAt])
  @@index([deletedAt, isHidden])
}

model CustomizationGroup {
  id                   String                @id @default(uuid(7))
  name                 String
  minSelectable        Int                   @default(0)
  maxSelectable        Int                   @default(1)
  menuItemId           String
  menuItem             MenuItem              @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  customizationOptions CustomizationOption[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([menuItemId])
}

model CustomizationOption {
  id                   String   @id @default(uuid(7))
  name                 String
  additionalPrice      Decimal? @db.Decimal(10, 2)
  customizationGroupId String

  customizationGroup      CustomizationGroup       @relation(fields: [customizationGroupId], references: [id], onDelete: Cascade)
  orderItemCustomizations OrderItemCustomization[]
  cartItemCustomizations  CartItemCustomization[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([customizationGroupId])
}

model Table {
  id            String      @id @default(uuid(7))
  storeId       String
  name          String
  currentStatus TableStatus @default(VACANT)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @default(now()) @updatedAt
  store         Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)

  activeTableSessions ActiveTableSession[]

  @@unique([storeId, name])
  @@index([storeId, name])
  @@index([storeId, currentStatus])
}

model ActiveTableSession {
  id            String        @id @default(uuid(7))
  storeId       String
  tableId       String?
  sessionType   SessionType   @default(TABLE)
  status        SessionStatus @default(ACTIVE)
  guestCount    Int           @default(1)
  sessionToken  String        @unique
  customerName  String?
  customerPhone String?
  closedAt      DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @default(now()) @updatedAt

  store  Store   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  table  Table?  @relation(fields: [tableId], references: [id], onDelete: Cascade)
  cart   Cart?
  orders Order[]

  @@index([storeId, status])
  @@index([tableId, status])
  @@index([sessionToken])
  @@index([storeId, sessionType])
}

model Cart {
  id        String   @id @default(uuid(7))
  sessionId String   @unique
  storeId   String
  subTotal  Decimal  @default(0) @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  store   Store              @relation(fields: [storeId], references: [id], onDelete: Cascade)
  session ActiveTableSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  items   CartItem[]

  @@index([storeId])
  @@index([sessionId])
}

model CartItem {
  id           String   @id @default(uuid(7))
  cartId       String
  menuItemId   String?
  menuItemName String // Snapshot for if menu item is deleted
  basePrice    Decimal  @db.Decimal(10, 2)
  quantity     Int      @default(1)
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  cart           Cart                    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  menuItem       MenuItem?               @relation(fields: [menuItemId], references: [id], onDelete: SetNull)
  customizations CartItemCustomization[]

  @@index([cartId])
  @@index([menuItemId])
}

model CartItemCustomization {
  id                    String   @id @default(uuid(7))
  cartItemId            String
  customizationOptionId String
  optionName            String // Snapshot for if option is deleted
  additionalPrice       Decimal? @db.Decimal(10, 2)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @default(now()) @updatedAt

  cartItem            CartItem            @relation(fields: [cartItemId], references: [id], onDelete: Cascade)
  customizationOption CustomizationOption @relation(fields: [customizationOptionId], references: [id], onDelete: Restrict)

  @@unique([cartItemId, customizationOptionId])
  @@index([cartItemId])
}

model Order {
  id          String      @id @default(uuid(7))
  orderNumber String // Human-readable order number (e.g., "001", "002")
  storeId     String
  sessionId   String?
  tableName   String
  status      OrderStatus @default(PENDING)
  orderType   OrderType   @default(DINE_IN)
  paidAt      DateTime?

  subTotal                  Decimal  @default(0) @db.Decimal(10, 2)
  vatRateSnapshot           Decimal? @db.Decimal(4, 3)
  serviceChargeRateSnapshot Decimal? @db.Decimal(4, 3)
  vatAmount                 Decimal  @default(0) @db.Decimal(10, 2)
  serviceChargeAmount       Decimal  @default(0) @db.Decimal(10, 2)
  grandTotal                Decimal  @default(0) @db.Decimal(10, 2)

  // Discount fields (Slice A - Task 8)
  discountType       DiscountType? // PERCENTAGE | FIXED_AMOUNT
  discountValue      Decimal?      @db.Decimal(10, 2) // 10% or $10.00
  discountAmount     Decimal?      @db.Decimal(10, 2) // Calculated discount
  discountReason     String?       // "Loyalty reward", "Manager comp", etc.
  discountAppliedBy  String?       // User ID who approved discount
  discountAppliedAt  DateTime?     // Timestamp of discount application

  store      Store               @relation(fields: [storeId], references: [id], onDelete: Restrict)
  session    ActiveTableSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  orderItems OrderItem[]
  payments   Payment[]
  refunds    Refund[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([storeId, orderNumber])
  @@index([storeId, createdAt])
  @@index([storeId, status])
  @@index([storeId, paidAt])
  @@index([sessionId])
  @@index([storeId, discountType]) // For discount reporting
  // KDS Performance Indexes
  @@index([storeId, status, createdAt])
  @@index([status, createdAt])
  @@index([createdAt(sort: Desc)])
}

model OrderItem {
  id         String   @id @default(uuid(7))
  orderId    String
  menuItemId String?
  price      Decimal  @db.Decimal(10, 2)
  quantity   Int      @default(1)
  finalPrice Decimal? @db.Decimal(10, 2)
  notes      String?

  order          Order                    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem       MenuItem?                @relation(fields: [menuItemId], references: [id], onDelete: SetNull)
  customizations OrderItemCustomization[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([orderId])
  @@index([menuItemId])
  @@index([orderId, menuItemId]) // For popular items report
  // KDS Performance Index
  @@index([orderId, createdAt])
}

model OrderItemCustomization {
  id                    String   @id @default(uuid(7))
  orderItemId           String
  customizationOptionId String
  finalPrice            Decimal? @db.Decimal(10, 2)

  orderItem OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  customizationOption CustomizationOption @relation(fields: [customizationOptionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([orderItemId, customizationOptionId])
}

model Payment {
  id             String        @id @default(uuid(7))
  orderId        String
  amount         Decimal       @db.Decimal(10, 2)
  paymentMethod  PaymentMethod
  amountTendered Decimal?      @db.Decimal(10, 2) // Cash only - amount given by customer
  change         Decimal?      @db.Decimal(10, 2) // Cash only - change to return
  transactionId  String? // External payment gateway transaction ID
  notes          String?

  // Bill Splitting Fields (Sprint 3)
  splitType     String? // EVEN | BY_ITEM | CUSTOM
  splitMetadata Json? // JSON metadata for split calculation
  guestNumber   Int? // Guest number for split payments (1, 2, 3, etc.)
  deletedAt     DateTime? // Soft delete support

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([orderId])
  @@index([transactionId])
  @@index([orderId, paymentMethod]) // For payment breakdown report
  @@index([deletedAt]) // For soft delete queries
  @@index([orderId, guestNumber]) // For split payment queries
}

model Refund {
  id         String  @id @default(uuid(7))
  orderId    String
  amount     Decimal @db.Decimal(10, 2)
  reason     String?
  refundedBy String? // Staff member who processed refund

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([orderId])
}

model StoreTier {
  id                 String             @id @default(uuid(7))
  storeId            String             @unique
  tier               Tier               @default(FREE)
  subscriptionId     String?            // Stripe subscription ID
  subscriptionStatus SubscriptionStatus @default(ACTIVE)
  billingCycle       BillingCycle       @default(MONTHLY)
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  trialEndsAt        DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @default(now()) @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId])
  @@index([tier])
  @@index([subscriptionStatus])
}

model AuditLog {
  id         String      @id @default(uuid(7))
  storeId    String
  userId     String?     // Nullable for system actions
  action     AuditAction
  entityType String      // "Store", "MenuItem", "Payment", "UserStore"
  entityId   String?     // UUID of affected entity
  details    Json?       // Flexible JSON for action-specific data
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime    @default(now())

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, createdAt])
  @@index([storeId, action])
  @@index([storeId, userId])
  @@index([createdAt])
}

model StaffInvitation {
  id              String    @id @default(uuid(7))
  storeId         String
  email           String
  role            Role
  invitedBy       String    // userId
  invitationToken String    @unique
  expiresAt       DateTime
  acceptedAt      DateTime?
  createdAt       DateTime  @default(now())

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, email])
  @@index([storeId])
  @@index([invitationToken])
  @@index([expiresAt])
}

enum Role {
  OWNER
  ADMIN
  CHEF
  CASHIER
  SERVER
}

enum Currency {
  THB
  MMK
  USD
  EUR
  JPY
  CNY
  SGD
  HKD
}

enum SessionStatus {
  ACTIVE
  CLOSED
}

enum OrderStatus {
  PENDING // Order placed, waiting for kitchen
  PREPARING // Being prepared by kitchen
  READY // Ready for serving
  SERVED // Served to customer
  COMPLETED // Fully paid and closed
  CANCELLED // Order cancelled
}

enum OrderType {
  DINE_IN
  TAKEAWAY
  DELIVERY
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  MOBILE_PAYMENT
  OTHER
}

enum RoutingArea {
  GRILL
  FRY
  SALAD
  DRINKS
  DESSERT
  APPETIZER
  SOUP
  OTHER
}

enum TableStatus {
  VACANT
  SEATED
  ORDERING
  SERVED
  READY_TO_PAY
  CLEANING
}

enum SessionType {
  TABLE
  COUNTER
  PHONE
  TAKEOUT
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum Tier {
  FREE
  STANDARD
  PREMIUM
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}

enum BillingCycle {
  MONTHLY
  ANNUAL
}

enum AuditAction {
  STORE_SETTING_CHANGED
  MENU_PRICE_CHANGED
  MENU_ITEM_86D
  PAYMENT_REFUNDED
  ORDER_VOIDED
  USER_ROLE_CHANGED
  USER_SUSPENDED
  USER_REACTIVATED
  TIER_UPGRADED
  TIER_DOWNGRADED
}
